{"ast":null,"code":"// CodeMirror, copyright (c) by Marijn Haverbeke and others\n// Distributed under an MIT license: https://codemirror.net/LICENSE\n// Define search commands. Depends on dialog.js or another\n// implementation of the openDialog method.\n// Replace works a little oddly -- it will do the replace on the next\n// Ctrl-G (or whatever is bound to findNext) press. You prevent a\n// replace by making sure the match is no longer selected when hitting\n// Ctrl-G.\n(function (mod) {\n  if (typeof exports == \"object\" && typeof module == \"object\") // CommonJS\n    mod(require(\"../../lib/codemirror\"), require(\"./searchcursor\"), require(\"../dialog/dialog\"));else if (typeof define == \"function\" && define.amd) // AMD\n    define([\"../../lib/codemirror\", \"./searchcursor\", \"../dialog/dialog\"], mod);else // Plain browser env\n    mod(CodeMirror);\n})(function (CodeMirror) {\n  \"use strict\";\n\n  function searchOverlay(query, caseInsensitive) {\n    if (typeof query == \"string\") query = new RegExp(query.replace(/[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|]/g, \"\\\\$&\"), caseInsensitive ? \"gi\" : \"g\");else if (!query.global) query = new RegExp(query.source, query.ignoreCase ? \"gi\" : \"g\");\n    return {\n      token: function (stream) {\n        query.lastIndex = stream.pos;\n        var match = query.exec(stream.string);\n\n        if (match && match.index == stream.pos) {\n          stream.pos += match[0].length || 1;\n          return \"searching\";\n        } else if (match) {\n          stream.pos = match.index;\n        } else {\n          stream.skipToEnd();\n        }\n      }\n    };\n  }\n\n  function SearchState() {\n    this.posFrom = this.posTo = this.lastQuery = this.query = null;\n    this.overlay = null;\n  }\n\n  function getSearchState(cm) {\n    return cm.state.search || (cm.state.search = new SearchState());\n  }\n\n  function queryCaseInsensitive(query) {\n    return typeof query == \"string\" && query == query.toLowerCase();\n  }\n\n  function getSearchCursor(cm, query, pos) {\n    // Heuristic: if the query string is all lowercase, do a case insensitive search.\n    return cm.getSearchCursor(query, pos, {\n      caseFold: queryCaseInsensitive(query),\n      multiline: true\n    });\n  }\n\n  function persistentDialog(cm, text, deflt, onEnter, onKeyDown) {\n    cm.openDialog(text, onEnter, {\n      value: deflt,\n      selectValueOnOpen: true,\n      closeOnEnter: false,\n      onClose: function () {\n        clearSearch(cm);\n      },\n      onKeyDown: onKeyDown\n    });\n  }\n\n  function dialog(cm, text, shortText, deflt, f) {\n    if (cm.openDialog) cm.openDialog(text, f, {\n      value: deflt,\n      selectValueOnOpen: true\n    });else f(prompt(shortText, deflt));\n  }\n\n  function confirmDialog(cm, text, shortText, fs) {\n    if (cm.openConfirm) cm.openConfirm(text, fs);else if (confirm(shortText)) fs[0]();\n  }\n\n  function parseString(string) {\n    return string.replace(/\\\\([nrt\\\\])/g, function (match, ch) {\n      if (ch == \"n\") return \"\\n\";\n      if (ch == \"r\") return \"\\r\";\n      if (ch == \"t\") return \"\\t\";\n      if (ch == \"\\\\\") return \"\\\\\";\n      return match;\n    });\n  }\n\n  function parseQuery(query) {\n    var isRE = query.match(/^\\/(.*)\\/([a-z]*)$/);\n\n    if (isRE) {\n      try {\n        query = new RegExp(isRE[1], isRE[2].indexOf(\"i\") == -1 ? \"\" : \"i\");\n      } catch (e) {} // Not a regular expression after all, do a string search\n\n    } else {\n      query = parseString(query);\n    }\n\n    if (typeof query == \"string\" ? query == \"\" : query.test(\"\")) query = /x^/;\n    return query;\n  }\n\n  function startSearch(cm, state, query) {\n    state.queryText = query;\n    state.query = parseQuery(query);\n    cm.removeOverlay(state.overlay, queryCaseInsensitive(state.query));\n    state.overlay = searchOverlay(state.query, queryCaseInsensitive(state.query));\n    cm.addOverlay(state.overlay);\n\n    if (cm.showMatchesOnScrollbar) {\n      if (state.annotate) {\n        state.annotate.clear();\n        state.annotate = null;\n      }\n\n      state.annotate = cm.showMatchesOnScrollbar(state.query, queryCaseInsensitive(state.query));\n    }\n  }\n\n  function doSearch(cm, rev, persistent, immediate) {\n    var state = getSearchState(cm);\n    if (state.query) return findNext(cm, rev);\n    var q = cm.getSelection() || state.lastQuery;\n    if (q instanceof RegExp && q.source == \"x^\") q = null;\n\n    if (persistent && cm.openDialog) {\n      var hiding = null;\n\n      var searchNext = function (query, event) {\n        CodeMirror.e_stop(event);\n        if (!query) return;\n\n        if (query != state.queryText) {\n          startSearch(cm, state, query);\n          state.posFrom = state.posTo = cm.getCursor();\n        }\n\n        if (hiding) hiding.style.opacity = 1;\n        findNext(cm, event.shiftKey, function (_, to) {\n          var dialog;\n          if (to.line < 3 && document.querySelector && (dialog = cm.display.wrapper.querySelector(\".CodeMirror-dialog\")) && dialog.getBoundingClientRect().bottom - 4 > cm.cursorCoords(to, \"window\").top) (hiding = dialog).style.opacity = .4;\n        });\n      };\n\n      persistentDialog(cm, getQueryDialog(cm), q, searchNext, function (event, query) {\n        var keyName = CodeMirror.keyName(event);\n        var extra = cm.getOption('extraKeys'),\n            cmd = extra && extra[keyName] || CodeMirror.keyMap[cm.getOption(\"keyMap\")][keyName];\n\n        if (cmd == \"findNext\" || cmd == \"findPrev\" || cmd == \"findPersistentNext\" || cmd == \"findPersistentPrev\") {\n          CodeMirror.e_stop(event);\n          startSearch(cm, getSearchState(cm), query);\n          cm.execCommand(cmd);\n        } else if (cmd == \"find\" || cmd == \"findPersistent\") {\n          CodeMirror.e_stop(event);\n          searchNext(query, event);\n        }\n      });\n\n      if (immediate && q) {\n        startSearch(cm, state, q);\n        findNext(cm, rev);\n      }\n    } else {\n      dialog(cm, getQueryDialog(cm), \"Search for:\", q, function (query) {\n        if (query && !state.query) cm.operation(function () {\n          startSearch(cm, state, query);\n          state.posFrom = state.posTo = cm.getCursor();\n          findNext(cm, rev);\n        });\n      });\n    }\n  }\n\n  function findNext(cm, rev, callback) {\n    cm.operation(function () {\n      var state = getSearchState(cm);\n      var cursor = getSearchCursor(cm, state.query, rev ? state.posFrom : state.posTo);\n\n      if (!cursor.find(rev)) {\n        cursor = getSearchCursor(cm, state.query, rev ? CodeMirror.Pos(cm.lastLine()) : CodeMirror.Pos(cm.firstLine(), 0));\n        if (!cursor.find(rev)) return;\n      }\n\n      cm.setSelection(cursor.from(), cursor.to());\n      cm.scrollIntoView({\n        from: cursor.from(),\n        to: cursor.to()\n      }, 20);\n      state.posFrom = cursor.from();\n      state.posTo = cursor.to();\n      if (callback) callback(cursor.from(), cursor.to());\n    });\n  }\n\n  function clearSearch(cm) {\n    cm.operation(function () {\n      var state = getSearchState(cm);\n      state.lastQuery = state.query;\n      if (!state.query) return;\n      state.query = state.queryText = null;\n      cm.removeOverlay(state.overlay);\n\n      if (state.annotate) {\n        state.annotate.clear();\n        state.annotate = null;\n      }\n    });\n  }\n\n  function getQueryDialog(cm) {\n    return '<span class=\"CodeMirror-search-label\">' + cm.phrase(\"Search:\") + '</span> <input type=\"text\" style=\"width: 10em\" class=\"CodeMirror-search-field\"/> <span style=\"color: #888\" class=\"CodeMirror-search-hint\">' + cm.phrase(\"(Use /re/ syntax for regexp search)\") + '</span>';\n  }\n\n  function getReplaceQueryDialog(cm) {\n    return ' <input type=\"text\" style=\"width: 10em\" class=\"CodeMirror-search-field\"/> <span style=\"color: #888\" class=\"CodeMirror-search-hint\">' + cm.phrase(\"(Use /re/ syntax for regexp search)\") + '</span>';\n  }\n\n  function getReplacementQueryDialog(cm) {\n    return '<span class=\"CodeMirror-search-label\">' + cm.phrase(\"With:\") + '</span> <input type=\"text\" style=\"width: 10em\" class=\"CodeMirror-search-field\"/>';\n  }\n\n  function getDoReplaceConfirm(cm) {\n    return '<span class=\"CodeMirror-search-label\">' + cm.phrase(\"Replace?\") + '</span> <button>' + cm.phrase(\"Yes\") + '</button> <button>' + cm.phrase(\"No\") + '</button> <button>' + cm.phrase(\"All\") + '</button> <button>' + cm.phrase(\"Stop\") + '</button> ';\n  }\n\n  function replaceAll(cm, query, text) {\n    cm.operation(function () {\n      for (var cursor = getSearchCursor(cm, query); cursor.findNext();) {\n        if (typeof query != \"string\") {\n          var match = cm.getRange(cursor.from(), cursor.to()).match(query);\n          cursor.replace(text.replace(/\\$(\\d)/g, function (_, i) {\n            return match[i];\n          }));\n        } else cursor.replace(text);\n      }\n    });\n  }\n\n  function replace(cm, all) {\n    if (cm.getOption(\"readOnly\")) return;\n    var query = cm.getSelection() || getSearchState(cm).lastQuery;\n    var dialogText = '<span class=\"CodeMirror-search-label\">' + (all ? cm.phrase(\"Replace all:\") : cm.phrase(\"Replace:\")) + '</span>';\n    dialog(cm, dialogText + getReplaceQueryDialog(cm), dialogText, query, function (query) {\n      if (!query) return;\n      query = parseQuery(query);\n      dialog(cm, getReplacementQueryDialog(cm), cm.phrase(\"Replace with:\"), \"\", function (text) {\n        text = parseString(text);\n\n        if (all) {\n          replaceAll(cm, query, text);\n        } else {\n          clearSearch(cm);\n          var cursor = getSearchCursor(cm, query, cm.getCursor(\"from\"));\n\n          var advance = function () {\n            var start = cursor.from(),\n                match;\n\n            if (!(match = cursor.findNext())) {\n              cursor = getSearchCursor(cm, query);\n              if (!(match = cursor.findNext()) || start && cursor.from().line == start.line && cursor.from().ch == start.ch) return;\n            }\n\n            cm.setSelection(cursor.from(), cursor.to());\n            cm.scrollIntoView({\n              from: cursor.from(),\n              to: cursor.to()\n            });\n            confirmDialog(cm, getDoReplaceConfirm(cm), cm.phrase(\"Replace?\"), [function () {\n              doReplace(match);\n            }, advance, function () {\n              replaceAll(cm, query, text);\n            }]);\n          };\n\n          var doReplace = function (match) {\n            cursor.replace(typeof query == \"string\" ? text : text.replace(/\\$(\\d)/g, function (_, i) {\n              return match[i];\n            }));\n            advance();\n          };\n\n          advance();\n        }\n      });\n    });\n  }\n\n  CodeMirror.commands.find = function (cm) {\n    clearSearch(cm);\n    doSearch(cm);\n  };\n\n  CodeMirror.commands.findPersistent = function (cm) {\n    clearSearch(cm);\n    doSearch(cm, false, true);\n  };\n\n  CodeMirror.commands.findPersistentNext = function (cm) {\n    doSearch(cm, false, true, true);\n  };\n\n  CodeMirror.commands.findPersistentPrev = function (cm) {\n    doSearch(cm, true, true, true);\n  };\n\n  CodeMirror.commands.findNext = doSearch;\n\n  CodeMirror.commands.findPrev = function (cm) {\n    doSearch(cm, true);\n  };\n\n  CodeMirror.commands.clearSearch = clearSearch;\n  CodeMirror.commands.replace = replace;\n\n  CodeMirror.commands.replaceAll = function (cm) {\n    replace(cm, true);\n  };\n});","map":null,"metadata":{},"sourceType":"script"}